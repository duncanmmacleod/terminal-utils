#!/usr/bin/env python

"""Clone a fork of a repository on github.com
"""

import argparse
import getpass
import os

if getpass.getuser() in ['duncan', 'duncan.macleod']:
    DEFAULT_USER='duncanmmacleod'
else:
    DEFAULT_USER=None


def shell(cmd):
    print("$ %s" % cmd)
    os.system(cmd)


parser = argparse.ArgumentParser(description=__doc__)
parser.add_argument('upstream', metavar='org/repo',
                    help='URI of repo on github.com, e.g. gwpy/gwpy')
parser.add_argument('user', help='username of fork owner',
                    default=DEFAULT_USER, nargs=DEFAULT_USER and '?' or 1)
parser.add_argument('-o', '--clone-dir',
                    help='target directory for clone',
                    default='./{repo}-fork')
parser.add_argument('-s', '--git-server', default='https://github.com',
                    help='URL of git server, default: %(default)s')

args = parser.parse_args()

try:
    org, repo = args.upstream.split('/', 1)
except ValueError:
    org = repo = args.upstream

upstream = '%s/%s/%s.git' % (args.git_server, org, repo)
fork = '%s/%s/%s.git' % (args.git_server, args.user, repo)

target = args.clone_dir
if target is None:
    target = '%s-fork' % repo

os.system('git clone %s %s' % (fork, target))

os.chdir(target)
os.system('git remote add upstream %s' % upstream)
os.system('git pull --rebase upstream master')
print("Fork is ready")
